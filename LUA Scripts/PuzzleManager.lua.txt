local prefabPool = Nil; 
local spawnEnabled = false;
currentPiece = 0;
newPiece = 0;
isNotTheSame = false;
oks = 0;
errors = 0;
totalOks = 5;
totalErrors = 3;
set =1;

fakes = {};

figureCounter = 1;
puzzleCounter = 1;

local distance = 10;
local goDepth = 4;

local v3ViewPort;
local v3BottomLeft;
local v3TopRight;
local width = 0;

local marginPercentage = 30;
local realMargin;
local currentAnswer = 0;
local randomSet = 0;

function Awake ()
    prefabPool = PoolManager.CreatePoolForPrefab (prefabToSpawn);
	puzzlePool = PoolManager.CreatePoolForPrefab (puzzleToSpawn);
	randomSet = Random.Range(0,2);
	if randomSet == 0 then
		randomPuzzles = UniqueRandomSequence.__new (#puzzles1+1);
		random = puzzles1[randomPuzzles.nextValue];
	else
		randomPuzzles = UniqueRandomSequence.__new (#puzzles2+1);
		random = puzzles2[randomPuzzles.nextValue];
	end

	maxSpawned = 4;

	fakes[0] = { img = alien, ans = "Alien" };
	fakes[1] = { img = boy, ans = "Boy" };
	fakes[2] = { img = cat, ans = "Cat" };
	fakes[3] = { img = desert, ans = "Desert" };
	fakes[4] = { img = earth, ans = "Earth" };
	fakes[5] = { img = football, ans = "Football" };
	fakes[6] = { img = girl, ans = "Girl" };
	fakes[7] = { img = grass, ans = "Grass" };
	fakes[8] = { img = hockey, ans = "Hockey" };
	fakes[9] = { img = hourglass, ans = "Hourglass" };
	fakes[10] = { img = ice, ans = "Ice" };
	fakes[11] = { img = mars, ans = "Mars" };
	fakes[12] = { img = music, ans = "Music" };
	fakes[13] = { img = sea, ans = "Sea" };
	fakes[14] = { img = sky, ans = "Sky" };
	fakes[15] = { img = velocimeter, ans = "Velocimeter" };

	fakes[16] = { img = baby, ans = "Baby" };
	fakes[17] = { img = antman, ans = "Antman" };
	fakes[18] = { img = apple, ans = "Apple" };
	fakes[19] = { img = banana, ans = "Banana" };
	fakes[20] = { img = batman, ans = "Batman" };
	fakes[21] = { img = bird, ans = "Bird" };
	fakes[22] = { img = car, ans = "Car" };
	fakes[23] = { img = chair, ans = "Chair" };
	fakes[24] = { img = countryside, ans = "Countryside" };
	fakes[25] = { img = dolphin, ans = "Dolphin" };
	fakes[26] = { img = egg, ans = "Egg" };
	fakes[27] = { img = hospital, ans = "Hospital" };
	fakes[28] = { img = kangoroo, ans = "Kangoroo" };
	fakes[29] = { img = lake, ans = "Lake" };
	fakes[30] = { img = parents, ans = "Parents" };
	fakes[31] = { img = school, ans = "School" };
	fakes[32] = { img = siblings, ans = "Siblings" };
	fakes[33] = { img = skyline, ans = "Skyline" };
	fakes[34] = { img = painting, ans = "Painting" };

	randomFakes = UniqueRandomSequence.__new (#fakes);

	rect = {};
	rect[0] = Vector3.__new (0,0,0);
	rect[1] = Vector3.__new (0,0,0);
	rect[2] = Vector3.__new (0,0,0);
	rect[3] = Vector3.__new (0,0,0);
	
end

function SpawnElements()
	PuzzleManager.DespawnAll ();
	FigureManager.DespawnAll ();
	--PoolManager.DespawnAll ();	
	figureCounter = 1;
	--Debug.Log(optionContainer.rect.xMin + optionContainer.position.x);
	--Debug.Log(optionContainer.rect.xMax + optionContainer.position.x);

	v3ViewPort = Vector3.__new (0, 0, optionContainer.rect.xMin + optionContainer.position.x);
	v3BottomLeft = Camera.main.ViewportToWorldPoint(v3ViewPort);
	v3ViewPort = Vector3.__new (1, 1, optionContainer.rect.xMax + optionContainer.position.x);
	v3TopRight = Camera.main.ViewportToWorldPoint(v3ViewPort);
	width = -1 * (v3BottomLeft.x - v3TopRight.x);

	for i=0, maxSpawned do
		-- Spawn puzzle figures and assign values
		
		randomFake = fakes[randomFakes.nextValue];

		if spawnEnabled == true and puzzlePool.spawnedCount < 1 then
			local puzzlePiece = PuzzleManager.SpanwAt (puzzleToSpawn, Vector3.__new (0,0,0), Quaternion.identity, answerContainer.transform);
			imageHolder = puzzlePiece.GetComponent ("LuaMonoBehaviourBinder").GetScriptGlobal ("image");

			imageHolder.sprite = random.illustration;
				
			puzzlePiece.GetComponent ("LuaMonoBehaviourBinder").CallFunction ("setOption", 1, answer1);
			puzzlePiece.GetComponent ("LuaMonoBehaviourBinder").cachedTransform.offsetMin = Vector2.__new (10,10);
			puzzlePiece.GetComponent ("LuaMonoBehaviourBinder").cachedTransform.offsetMax = Vector2.__new (-10,-10);
				
			answer1 = puzzlePiece.GetComponent ("LuaMonoBehaviourBinder").cachedTransform;
		end

		--textContainer.text = random.texte;

		-- Spawn user figures and assign values
		if spawnEnabled == true and prefabPool.spawnedCount < 3 then
			local figure = FigureManager.SpanwAt (prefabToSpawn, Vector3.__new (0,0,0), Quaternion.identity, prefabContainer.transform);
			imageHolder = figure.GetComponent ("LuaMonoBehaviourBinder").GetScriptGlobal ("image");
			textHolder = figure.GetComponent ("LuaMonoBehaviourBinder").GetScriptGlobal ("texter");
			if Random.Range(0,2) == 1 then
				figure.transform.SetAsFirstSibling();
			end
			if figureCounter == 1 then
				imageHolder.sprite = random.img;
				textHolder.text = random.texte;
				figure.GetComponent ("LuaMonoBehaviourBinder").CallFunction ("setOption", 1, optionContainer, canvas.scaleFactor, random.ans, random.texte);
			else
				if randomFake == random.img then
					randomFake = fakes[randomFakes.nextValue];
				end
				imageHolder.sprite = randomFake.img;
				textHolder.text = " ";
				figure.GetComponent ("LuaMonoBehaviourBinder").CallFunction ("setOption", 2, optionContainer, canvas.scaleFactor, randomFake.ans, random.texte); --answer2
			end
			figureCounter = figureCounter + 1;
		end
		
	end
end

function Update ()
	--Debug.Log(optionContainer.position);
	v3ViewPort = Vector3.__new (0, 0, optionContainer.rect.xMin + optionContainer.position.x);
	v3BottomLeft = Camera.main.ViewportToWorldPoint(v3ViewPort);
	v3ViewPort = Vector3.__new (1, 1, optionContainer.rect.xMax + optionContainer.position.x);
	v3TopRight = Camera.main.ViewportToWorldPoint(v3ViewPort);
	width = -1 * (v3BottomLeft.x - v3TopRight.x);

	-- Checked manipulated piece and tack back the other in case it exists
    if currentPiece == 0 then
        currentPiece = newPiece;
    else
        if currentPiece != newPiece and isNotTheSame == false then
            currentPiece.GetComponent ("LuaMonoBehaviourBinder").CallFunction ("setReset", true);
            isNotTheSame = true;
        elseif currentPiece != newPiece and isNotTheSame == true then
            currentPiece = newPiece;
            isNotTheSame = false;
        end
    end
end

function EnableSpawn (e)
    spawnEnabled = e;
end

function setCurrentPiece (piece)
    newPiece = piece;
end

function Score(e)
    oks = oks + 1;
	textContainer.text = random.answerTexte;
	
    MiniGameManager.MarkAssert ();

	currentAnswer = currentAnswer +1;
	--MiniGameManager.StartTimer (20);
	set = 2;
	prefabPool = Nil; 
	currentPiece = 0;
	newPiece = 0;
	isNotTheSame = false;
	currentAnswer = 0;

	figureCounter = 1;
	prefabPool = PoolManager.CreatePoolForPrefab (prefabToSpawn);
	puzzlePool = PoolManager.CreatePoolForPrefab (puzzleToSpawn);
	
	if randomSet == 0 then
		random = puzzles1[randomPuzzles.nextValue];
	else
		random = puzzles2[randomPuzzles.nextValue];
	end

	maxSpawned = 4;
	owner.CallFunctionWithDelay ("SpawnElements", 1);
	
	if oks >=totalOks then
		--PoolManager.DespawnAll ();	
		--PuzzleManager.DespawnAll ();
		--FigureManager.DespawnAll ();
        owner.CallFunctionWithDelay ("EndPresentation", 0);
    end
end

function Error(e)
	errors = errors +1;
	--MiniGameManager.MarkError ();
	MiniGameManager.TakeLive ();
	if errors >=totalErrors then
		--PoolManager.DespawnAll ();	
		--PuzzleManager.DespawnAll ();
		--FigureManager.DespawnAll ();
        --owner.CallFunctionWithDelay ("EndPresentation", 0);
    end
end

function EndPresentation()
	owner.CallFunctionWithDelay ("EndGame", 1);
end

function EndGame()
	logicManager.EndMiniGame ();    
	--PoolManager.DespawnAll ();	
end

function Reset ()
	prefabPool = Nil; 
	currentPiece = 0;
	newPiece = 0;
	isNotTheSame = false;
	oks = 0;
	errors = 0;

	figureCounter = 1;
	
	prefabPool = PoolManager.CreatePoolForPrefab (prefabToSpawn);
	puzzlePool = PoolManager.CreatePoolForPrefab (puzzleToSpawn);

	randomSet = Random.Range(0,2);
	if randomSet == 0 then
		randomPuzzles = UniqueRandomSequence.__new (#puzzles1+1);
		random = puzzles1[randomPuzzles.nextValue];
	else
		randomPuzzles = UniqueRandomSequence.__new (#puzzles2+1);
		random = puzzles2[randomPuzzles.nextValue];
	end

	maxSpawned = 4;
	SpawnElements();
end